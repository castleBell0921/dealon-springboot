<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dealOn.product.model.mapper.ProductMapper">

    <resultMap id="productResultMap" type="com.dealOn.product.model.vo.ProductVO">
        <result property="productNo" column="PRODUCT_NO"/>
        <result property="name" column="NAME"/>
        <result property="detail" column="DETAIL"/>
        <result property="createDate" column="CREATE_DATE"/>
        <result property="category" column="CATEGORY"/>
        <result property="location" column="LOCATION"/>
        <result property="currentPriceUnified" column="CURRENT_PRICE_UNIFIED"/>
        <result property="views" column="VIEWS"/>
        <result property="productType" column="PRODUCT_TYPE"/>
        <result property="imageUrl" column="IMAGE_URL"/>
    </resultMap>

    <resultMap id="categoryResultMap" type="com.dealOn.common.model.vo.CategoryVO">
        <result property="name" column="NAME"/>
    </resultMap>

    <select id="findProducts" parameterType="map" resultMap="productResultMap">
        SELECT
        P.NO AS PRODUCT_NO,
        P.NAME,
        P.DETAIL,
        TO_CHAR(P.CREATE_DATE, 'YYYY-MM-DD') AS CREATE_DATE,
        P.CATEGORY,
        P.SALES_LOCATION AS LOCATION,
        COALESCE(TO_NUMBER(N.PRICE), TO_NUMBER(A.CURRENT_PRICE)) AS CURRENT_PRICE_UNIFIED,
        COALESCE(TO_NUMBER(N.VIEWS), TO_NUMBER(A.VIEWS)) AS VIEWS,
        CASE
        WHEN N.NO IS NOT NULL THEN 'USED'
        WHEN A.NO IS NOT NULL THEN 'AUCTION'
        ELSE 'UNKNOWN'
        END AS PRODUCT_TYPE,
        (SELECT IM.IMAGE_URL
        FROM IMAGES IM
        WHERE IM.ENTITY_TYPE = 'PRODUCT' AND IM.ENTITY_ID = P.NO
        ORDER BY IM.DISPLAY_ORDER ASC, IM.UPLOAD_DATE DESC
        FETCH FIRST 1 ROW ONLY) AS IMAGE_URL
        FROM PRODUCT P
        LEFT JOIN NORMAL N ON P.NO = N.NO2
        LEFT JOIN AUCTION A ON P.NO = A.NO2
        <where>
            <if test="category != null and category != ''">
                AND P.CATEGORY = (SELECT NO FROM CATEGORY WHERE NAME = #{category})
            </if>
            <if test="location != null and location != ''">
                AND P.SALES_LOCATION LIKE '%' || #{location} || '%'
            </if>
            <if test="minPrice != null">
                AND COALESCE(TO_NUMBER(N.PRICE), TO_NUMBER(A.CURRENT_PRICE)) >= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND COALESCE(TO_NUMBER(N.PRICE), TO_NUMBER(A.CURRENT_PRICE)) &lt;= #{maxPrice}
            </if>
            <if test="availableOnly == true">
                AND N.STATE != 'N'
            </if>
        </where>
        ORDER BY P.CREATE_DATE DESC
    </select>

    <select id="findAllCategories" resultMap="categoryResultMap">
        SELECT DISTINCT C.NAME
        FROM CATEGORY C
                 JOIN PRODUCT P ON C.NO = P.CATEGORY
        ORDER BY C.NAME ASC
    </select>
</mapper>