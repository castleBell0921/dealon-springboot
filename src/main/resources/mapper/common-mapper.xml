<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dealOn.common.model.mapper.CommonMapper">

	<insert id="recentSearchSave">
    MERGE INTO user_recent_search urs
	    USING (SELECT #{userNo} AS user_no, #{keyword} AS keyword FROM dual) src
	    ON (urs.user_no = src.user_no AND urs.keyword = src.keyword)
	    WHEN MATCHED THEN
	        UPDATE SET created_date = SYSDATE
	    WHEN NOT MATCHED THEN
	        INSERT (user_no, keyword, created_date)
	        VALUES (src.user_no, src.keyword, SYSDATE)
	</insert>
	<delete id="deleteOldSearches">
	    DELETE FROM user_recent_search
	    WHERE user_no = #{userNo}
	      AND keyword IN (
	          SELECT keyword FROM (
	              SELECT keyword, ROW_NUMBER() OVER (ORDER BY created_date DESC) rn
	              FROM user_recent_search
	              WHERE user_no = #{userNo}
	          ) WHERE rn > 10
	      )
	</delete>
	<select id="getRecentSearch">
		SELECT * 
		FROM USER_RECENT_SEARCH
		WHERE USER_NO=#{userNo}
	</select>
	<insert id="recentViewSave">
    	MERGE INTO user_recent_view urv
	    USING (
	        SELECT 
	            #{userNo} AS user_no, 
	            #{productNo} AS product_no, 
	            #{productName} AS product_name, 
	            #{productImage} AS product_image 
	        FROM dual
	    ) src
	    ON (
	        urv.user_no = src.user_no 
	        AND urv.product_no = src.product_no
	    )
	    WHEN MATCHED THEN
	        UPDATE SET 
	            urv.created_date = SYSDATE,
	            urv.product_name = src.product_name,
	            urv.product_image = src.product_image
	    WHEN NOT MATCHED THEN
	        INSERT (user_no, product_no, created_date, product_name, product_image)
	        VALUES (src.user_no, src.product_no, SYSDATE, src.product_name, src.product_image)
	</insert>
	<delete id="deleteOldView">
	    DELETE FROM user_recent_view
	    WHERE user_no = #{userNo}
	      AND product_no IN (
	          SELECT product_no FROM (
	              SELECT product_No, ROW_NUMBER() OVER (ORDER BY created_date DESC) rn
	              FROM user_recent_view
	              WHERE user_no = #{userNo}
	          ) WHERE rn > 4
	      )
	</delete>
	<select id="getRecentView">
		select *
		from user_recent_view 
		where user_no=#{userNo}
		ORDER BY created_date DESC
		
	</select>

</mapper>