<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>채팅방</title>


<!-- Font Awesome 아이콘 -->
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" th:href="@{/css/App.css}">
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet" th:href="@{/css/chat.css}">
<link rel="stylesheet" th:href="@{/css/font.css}">
<link rel="stylesheet" th:href="@{/css/footer.css}">


</head>
<body>
	<div id="messageBox" class="toast-message"></div>
	<div class="app-container">
		<div th:replace="~{common/header :: header}"></div>
		<div th:replace="~{common/searchbar :: searchbar}"></div>

		<div class="chat-app-container">
			<input type="hidden" th:value="${session.loginUser.userNo}" id="userNo">
			<section class="panel chat-list-panel">
				<div class="panel-header text-36px">
					<a>전체 대화</a>
				</div>
				<hr
					style="height: 2px; background-color: #B57EDC; border: none; width: 578px;">


				<ul class="chat-list">
					<li th:each="chat : ${chatList}" class="chat-item"th:data-chat-no="${chat.chatNo}">
						<div class="avatar">👤</div>
						<div class="chat-content">
							<div class="user-name" th:text="${chat.nickname}"></div>
							<div class="message-preview"
								th:text="${lastChat[chat.chatNo] != null} ? ${#strings.abbreviate(lastChat[chat.chatNo].message, 11)} : '대화 내용이 없습니다.'">
							</div>
						</div>
						<div class="chat-meta">
							<div class="timestamp"
							     th:with="
							        msg=${lastChat[chat.chatNo]},
							        msgTime=${msg != null} ? ${msg.timestamp} : null,
							        msgDate=${msgTime != null} ? ${#temporals.format(msgTime, 'yyyy-MM-dd')} : null,
							        today=${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}
							     "
							     th:text="${msgTime} == null ? '' 
							              : (${msgDate} == ${today} 
							                    ? ${#temporals.format(msgTime,'a hh:mm')} 
							                    : ${#temporals.format(msgTime,'yyyy-MM-dd HH:mm')})">
							</div>


							<img th:src="${chat.imageUrl}" class="thumbnail">
						</div>
					</li>
				</ul>
			</section>

			<section class="panel chat-view-panel" th:if="${currentChat != null}">
				<div class="chat-header text-20px">
					<!-- <button class="icon-button">←</button> -->
					<!-- <span th:text="${currentChat != null ? currentChat.nickname : (chatInfo != null ? chatInfo.nickname : '이름 없음')}"></span> -->
					<span th:text="${chatInfo.nickname}"></span>

					<button class="icon-button" id="toggleButton">☰</button>

					<div id="dropdownMenu" class="dropdown-menu" role="menu">
					    <div class="menu-wrapper">
					        <a data-action="report" class="menu-item item-top" role="menuitem">신고하기</a>
					        <a data-action="leave" class="menu-item item-bottom" role="menuitem">채팅방 나가기</a>
					    </div>
					</div>
				</div>
				
				

				<div class="product-bar" id="product-bar">
					<img th:src="${chatInfo.imageUrl}" class="product-image">
					<div class="product-info">
						<input type="hidden" id="productNo" th:value="${chatInfo.productNo}">
						<div class="product-name" th:text="${chatInfo.name}"></div>
						<div class="product-price" th:text="${chatInfo.price}"></div>
					</div>
				</div>

				<!-- 채팅 메시지 영역 시작 -->
				<div class="message-area">
					<!-- 메시지 리스트를 담는 UL 태그로 변경 -->
					<ul class="message-list" th:each="msg : ${message}">
						<!-- 날짜 구분선 및 모든 메시지 블록을 LI 태그로 변경 -->
						<div
							th:if="${#temporals.format(msg.timestamp,'yyyy-MM-dd') != prevDate}"
							th:text="${#temporals.format(msg.timestamp,'yyyy년 MM월 dd일')}"
							th:with="prevDate=${#temporals.format(msg.timestamp,'yyyy-MM-dd')}">
						</div>

						<!-- 보낸 메시지 (li) -->
						<!-- <li th:class="${loginUser.userNo == msg.senderNo} ? 'message' : 'received'">
				        	<div class="timestamp" th:text="${#temporals.format(msg.timestamp,'HH:mm')}"></div>
							<div class="message-bubble" th:text="${msg.message}"></div>
						</li> -->
						<li th:if="${loginUser.userNo == msg.senderNo}" class="message">
							<div class="timestamp"
								th:text="${#temporals.format(msg.timestamp,'yyyy-MM-dd HH:mm')}"></div>
							<div class="message-bubble" th:text="${msg.message}"></div>
						</li>

						<!-- 상대방이 보낸 메시지(received)일 경우: 말풍선 -> 시간 순서 -->
						<li th:unless="${loginUser.userNo == msg.senderNo}"
							class="received">
							<div class="message-bubble" th:text="${msg.message}"></div>
							<div class="timestamp"
								th:text="${#temporals.format(msg.timestamp,'yyyy-MM-dd HH:mm')}"></div>
						</li>

					</ul>

				</div>

				<div class="input-area">
					<button class="icon-button">+</button>
					<input type="text" class="message-input" placeholder="메시지를 입력하세요.">
					<button class="send-button">➤</button>
				</div>
			</section>

			<section class="panel chat-view-panel" th:if="${currentChat == null}">
				<div class="message-area">
					<p>채팅방을 선택해주세요.</p>
				</div>
			</section>
		</div>
	</div>
	<div id="reportModal" class="report-modal-overlay">
	    <div class="report-modal-content">
	        <div class="report-modal-header">
	            <h3>신고하기</h3>
	            <button type="button" class="report-close-modal" onclick="closeReportModal()">&times;</button>
	        </div>
	        <form id="reportForm" onsubmit="submitReport(event)">
	            <p class="report-guide">신고 사유를 선택해주세요. 허위 신고 시 이용 제한을 받을 수 있습니다.</p>
	            
	            <div class="report-reasons">
	                <label class="reason-item">
	                    <input type="radio" name="reportReason" value="PROHIBITED" required>
	                    <span>욕설 / 과도한 표현 신고</span>
	                </label>
	                <label class="reason-item">
	                    <input type="radio" name="reportReason" value="SCAM">
	                    <span>사기 의심 게시글이에요</span>
	                </label>
	                <label class="reason-item">
	                    <input type="radio" name="reportReason" value="AD">
	                    <span>광고/홍보성 글이에요</span>
	                </label>
	                <label class="reason-item">
	                    <input type="radio" name="reportReason" value="OTHER">
	                    <span>기타 사유</span>
	                </label>
	            </div>
	
	            <textarea id="reportDetail" placeholder="상세 사유를 입력해주세요 (선택사항)" maxlength="200"></textarea>
	
	            <div class="modal-footer">
	                <button type="button" class="btn-cancel" onclick="closeReportModal()">취소</button>
	                <button type="submit" class="btn-submit">신고하기</button>
	            </div>
	        </form>
	    </div>
	</div>
	<div th:replace="~{common/footer :: footer}"></div> 
	<script th:src="@{/js/user/header.js}"></script>
	<script th:src="@{/js/chat/chat.js}"></script>
	<script th:src="@{/js/common/searchBar.js}"></script>
</body>
</html>